version: 3
repos:
  - id: https://github.com/Sandeep13Paul/terraform-tutorial
    workflow: custom_workflow
    allowed_overrides: [workflow]
    allow_custom_workflows: true
    autoplan:
      enabled: true
      when_modified: ["*.tf", "*.tfvars"]

workflows:
  default:
    plan:
      steps:
        - run: rm -rf .terraform .terraform.lock.hcl
        - run: terraform init
        - run: |
            echo "Env check: length of GOOGLE_CREDENTIALS = $(echo "$TF_VAR_GOOGLE_CREDENTIALS" | wc -c)"
            echo "$TF_VAR_GOOGLE_CREDENTIALS" | base64 -d > decoded.json || echo "Base64 decode failed"
            terraform plan
    apply:
      steps:
        - run: terraform apply tfplan