# version: 3
# repos:
#   - id: https://github.com/Sandeep13Paul/terraform-tutorial
#     workflow: default
#     allowed_overrides: [workflow]
#     allow_custom_workflows: true
#     autoplan:
#       enabled: true
#       when_modified: ["*.tf", "*.tfvars"]
# workflows:
#   default:
#     plan:
#       steps:
#         - run: rm -rf .terraform .terraform.lock.hcl
#         - run: terraform init -upgrade
#         - run: |
#             echo "Checking if TF_VAR_GOOGLE_CREDENTIALS is set..."
#             if [ -z "$TF_VAR_GOOGLE_CREDENTIALS" ]; then
#               echo "ERROR: TF_VAR_GOOGLE_CREDENTIALS is not set"
#               exit 1
#             fi
#             echo "TF_VAR_GOOGLE_CREDENTIALS is set, proceeding with plan..."
#             terraform plan -var="google_creds=${TF_VAR_GOOGLE_CREDENTIALS}" -out=tfplan
#     apply:
#       steps:
#         - run: terraform apply tfplan

version: 3
repos:
  - id: https://github.com/Sandeep13Paul/terraform-tutorial
    workflow: custom_workflow  # Changed from 'default' to 'custom_workflow'
    allowed_overrides: [workflow]
    allow_custom_workflows: true
    autoplan:
      enabled: true
      when_modified: ["*.tf", "*.tfvars"]
workflows:
  custom_workflow:  # Changed from 'default' to 'custom_workflow'
    plan:
      steps:
        - run: rm -rf .terraform .terraform.lock.hcl
        - run: |
            echo "=== Creating credentials and tfvars files ==="
            echo "$TF_VAR_GOOGLE_CREDENTIALS" | base64 -d > /tmp/gcp-credentials.json
            echo 'google_creds = "/tmp/gcp-credentials.json"' > terraform.tfvars
            echo "Files created successfully"
            echo "Contents of terraform.tfvars:"
            cat terraform.tfvars
        - run: terraform init -upgrade
        - run: terraform plan -out=tfplan
    apply:
      steps:
        - run: |
            echo "$TF_VAR_GOOGLE_CREDENTIALS" | base64 -d > /tmp/gcp-credentials.json
            echo 'google_creds = "/tmp/gcp-credentials.json"' > terraform.tfvars
        - run: terraform apply tfplan